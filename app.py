# app.py
# ì‹¤í–‰:
#   pip install streamlit requests
#   streamlit run app.py

import streamlit as st
import requests
from collections import Counter

# -----------------------
# í˜ì´ì§€ ì„¤ì •
# -----------------------
st.set_page_config(
    page_title="ğŸ¬ ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?",
    page_icon="ğŸ¬",
    layout="wide",
)

# -----------------------
# ì¥ë¥´ ì •ë³´
# -----------------------
GENRE_INFO = {
    "ë¡œë§¨ìŠ¤/ë“œë¼ë§ˆ": {
        "ids": [10749, 18],
        "emoji": "ğŸ’ğŸ­",
        "desc": "ê°ì •ì— ê³µê°í•˜ê³  ê´€ê³„ì˜ íë¦„ì„ ì¤‘ìš”í•˜ê²Œ ì—¬ê¸°ëŠ” íƒ€ì…"
    },
    "ì•¡ì…˜/ì–´ë“œë²¤ì²˜": {
        "ids": [28],
        "emoji": "ğŸ”¥ğŸƒâ€â™‚ï¸",
        "desc": "ë„ì „ê³¼ ì—ë„ˆì§€, ëª°ì…ê°ì„ ì¦ê¸°ëŠ” íƒ€ì…"
    },
    "SF/íŒíƒ€ì§€": {
        "ids": [878, 14],
        "emoji": "ğŸš€ğŸ§™",
        "desc": "ìƒìƒë ¥ê³¼ ì„¸ê³„ê´€ì— ë¹ ì ¸ë“œëŠ” íƒ€ì…"
    },
    "ì½”ë¯¸ë””": {
        "ids": [35],
        "emoji": "ğŸ˜‚ğŸ‰",
        "desc": "ì›ƒìŒê³¼ ë¶„ìœ„ê¸°ë¥¼ ì¤‘ì‹œí•˜ëŠ” íƒ€ì…"
    },
}

# -----------------------
# ì‚¬ì´ë“œë°”
# -----------------------
with st.sidebar:
    st.header("ğŸ”‘ API ì„¤ì •")
    tmdb_api_key = st.text_input(
        "TMDB API Key",
        type="password",
        placeholder="TMDB API Key ì…ë ¥",
    )

    st.markdown("---")
    st.markdown("ğŸ“ **ëŒ€í•™ìƒ ëŒ€ìƒ ì‹¬ë¦¬í…ŒìŠ¤íŠ¸**")
    st.caption("ê²°ê³¼ëŠ” ì¬ë¯¸ìš©ì…ë‹ˆë‹¤ ğŸ˜„")

# -----------------------
# ì œëª© & ì†Œê°œ
# -----------------------
st.title("ğŸ¬ ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?")
st.markdown(
    """
    ê°„ë‹¨í•œ ì§ˆë¬¸ì„ í†µí•´  
    **ë‹¹ì‹ ì˜ ì„±í–¥ì— ì–´ìš¸ë¦¬ëŠ” ì˜í™” ì¥ë¥´ì™€ ì˜í™” ì¶”ì²œ**ì„ ì•Œë ¤ë“œë ¤ìš” ğŸ¿âœ¨  
    """
)

st.divider()

# -----------------------
# ì§ˆë¬¸ ë°ì´í„°
# -----------------------
questions = [
    ("â“ Q1. ì‹œí—˜ ëë‚œ ê¸ˆìš”ì¼ ë°¤, ë„ˆì˜ ì„ íƒì€?",
     {
         "â˜• ì¡°ìš©í•œ ì¹´í˜ì—ì„œ ì¹œêµ¬ë‘ ê¹Šì€ ì–˜ê¸°": "ë¡œë§¨ìŠ¤/ë“œë¼ë§ˆ",
         "ğŸš— ì¦‰í¥ ì—¬í–‰! ì•¼ê°„ ë“œë¼ì´ë¸Œë‚˜ ì•¡í‹°ë¹„í‹°": "ì•¡ì…˜/ì–´ë“œë²¤ì²˜",
         "ğŸ‘½ ì§‘ì—ì„œ ìƒìƒë ¥ í­ë°œ ì½˜í…ì¸  ëª°ì•„ë³´ê¸°": "SF/íŒíƒ€ì§€",
         "ğŸ˜‚ ì¹œêµ¬ë“¤ ëª¨ì—¬ ì›ƒê³  ë– ë“¤ê¸°": "ì½”ë¯¸ë””",
     }),
    ("â“ Q2. ê³¼ì œ ë•Œë¬¸ì— ë°¤ìƒ˜í•  ë•Œ, ë„ˆë¥¼ ë²„í‹°ê²Œ í•˜ëŠ” ê±´?",
     {
         "ğŸ§ ê°ì • ëª°ì…ë˜ëŠ” í”Œë ˆì´ë¦¬ìŠ¤íŠ¸": "ë¡œë§¨ìŠ¤/ë“œë¼ë§ˆ",
         "ğŸ’ª ëë‚´ê³  ë†€ê² ë‹¤ëŠ” ìŠ¹ë¶€ìš•": "ì•¡ì…˜/ì–´ë“œë²¤ì²˜",
         "ğŸš€ ë¯¸ë˜ì˜ ë‚˜ë¥¼ ìƒìƒí•˜ëŠ” ìƒìƒë ¥": "SF/íŒíƒ€ì§€",
         "ğŸ¤£ ë°ˆê³¼ ì§¤, ì›ƒê¸´ ì˜ìƒ": "ì½”ë¯¸ë””",
     }),
    ("â“ Q3. ì²˜ìŒ ê°„ MTì—ì„œ ë„ˆëŠ” ì–´ë–¤ ìºë¦­í„°?",
     {
         "ğŸŒ™ ì¡°ìš©íˆ ë¶„ìœ„ê¸° ì½ëŠ” íƒ€ì…": "ë¡œë§¨ìŠ¤/ë“œë¼ë§ˆ",
         "ğŸ”¥ ê²Œì„ê³¼ ë ˆí¬ë¦¬ì—ì´ì…˜ ì£¼ë„": "ì•¡ì…˜/ì–´ë“œë²¤ì²˜",
         "ğŸª ë…íŠ¹í•œ ì„¸ê³„ê´€ ë§Œë“œëŠ” ì‚¬ëŒ": "SF/íŒíƒ€ì§€",
         "ğŸ¤ ì›ƒìŒ í¬ì¸íŠ¸ ë‹´ë‹¹": "ì½”ë¯¸ë””",
     }),
    ("â“ Q4. ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ê·¹ì— ë‹¬í–ˆì„ ë•Œ ì œì¼ í•˜ê³  ì‹¶ì€ ê±´?",
     {
         "ğŸ˜¢ í˜¼ì ê°ì • ì •ë¦¬í•˜ê¸°": "ë¡œë§¨ìŠ¤/ë“œë¼ë§ˆ",
         "ğŸƒâ€â™‚ï¸ ê²©í•˜ê²Œ ëª¸ ì“°ëŠ” í™œë™": "ì•¡ì…˜/ì–´ë“œë²¤ì²˜",
         "ğŸŒŒ í˜„ì‹¤ì„ ìŠëŠ” ë‹¤ë¥¸ ì„¸ê³„ë¡œ ë„í”¼": "SF/íŒíƒ€ì§€",
         "ğŸ» ì•„ë¬´ ìƒê° ì—†ì´ ì›ƒê¸°": "ì½”ë¯¸ë””",
     }),
    ("â“ Q5. ì˜í™” ì£¼ì¸ê³µì´ ëœë‹¤ë©´, ë„ˆì˜ ì—­í• ì€?",
     {
         "ğŸ’ ê°ì •ì„ ì´ë„ëŠ” ì¤‘ì‹¬ ì¸ë¬¼": "ë¡œë§¨ìŠ¤/ë“œë¼ë§ˆ",
         "ğŸ¦¸ ìœ„ê¸°ë§ˆë‹¤ ëª¸ ë˜ì§€ëŠ” íˆì–´ë¡œ": "ì•¡ì…˜/ì–´ë“œë²¤ì²˜",
         "ğŸ”® ì„¸ê³„ì˜ ë¹„ë°€ì„ í‘¸ëŠ” ì¡´ì¬": "SF/íŒíƒ€ì§€",
         "ğŸ˜œ ë¶„ìœ„ê¸° ì‚´ë¦¬ëŠ” ì”¬ìŠ¤í‹¸ëŸ¬": "ì½”ë¯¸ë””",
     }),
]

# -----------------------
# ì§ˆë¬¸ UI
# -----------------------
answers = []

for i, (q, opts) in enumerate(questions):
    choice = st.radio(q, list(opts.keys()), key=f"q{i}")
    answers.append(opts[choice])
    st.write("")

st.divider()

# -----------------------
# ê²°ê³¼
# -----------------------
if st.button("ğŸ¯ ê²°ê³¼ ë³´ê¸°", use_container_width=True):
    if not tmdb_api_key:
        st.error("âš ï¸ ì‚¬ì´ë“œë°”ì— TMDB API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        st.stop()

    counter = Counter(answers)
    top_two = counter.most_common(2)

    main_genre = top_two[0][0]
    sub_genre = top_two[1][0]

    st.markdown("## ğŸ§  ë¶„ì„ ê²°ê³¼")
    st.markdown(
        f"""
        ### {GENRE_INFO[main_genre]['emoji']} **{main_genre}**
        {GENRE_INFO[main_genre]['desc']}

        ### {GENRE_INFO[sub_genre]['emoji']} **{sub_genre}**
        {GENRE_INFO[sub_genre]['desc']}
        """
    )

    st.success(
        f"ğŸ¯ ë‹¹ì‹ ì€ **{main_genre} + {sub_genre}** ì„±í–¥ì´ ì¡°í•©ëœ íƒ€ì…ì´ì—ìš”!"
    )

    # -----------------------
    # TMDB API í˜¸ì¶œ (ë³µí•© ì¥ë¥´)
    # -----------------------
    genre_ids = GENRE_INFO[main_genre]["ids"] + GENRE_INFO[sub_genre]["ids"]
    genre_query = ",".join(map(str, set(genre_ids)))

    url = (
        "https://api.themoviedb.org/3/discover/movie"
        f"?api_key={tmdb_api_key}"
        f"&with_genres={genre_query}"
        "&language=ko-KR"
        "&sort_by=popularity.desc"
    )

    movies = requests.get(url).json().get("results", [])[:5]

    st.markdown("## ğŸ¿ ë‹¹ì‹ ì„ ìœ„í•œ ì˜í™” ì¶”ì²œ")

    for movie in movies:
        col1, col2 = st.columns([1, 3])

        with col1:
            if movie.get("poster_path"):
                st.image(
                    "https://image.tmdb.org/t/p/w500" + movie["poster_path"],
                    use_container_width=True
                )

        with col2:
            st.markdown(f"### ğŸ¬ {movie.get('title', 'ì œëª© ì—†ìŒ')}")
            st.write(f"â­ í‰ì : {movie.get('vote_average', 'N/A')}")
            st.write(movie.get("overview", "ì¤„ê±°ë¦¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."))

            st.info(
                f"ğŸ’¡ ì¶”ì²œ ì´ìœ :  \n"
                f"ì´ ì˜í™”ëŠ” **{main_genre}ì˜ ë§¤ë ¥**ê³¼ "
                f"**{sub_genre}ì˜ ë¶„ìœ„ê¸°**ë¥¼ ëª¨ë‘ ëŠë‚„ ìˆ˜ ìˆì–´ìš”."
            )

        st.divider()
