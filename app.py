# app.py
# ì‹¤í–‰:
#   pip install streamlit requests
#   streamlit run app.py

import streamlit as st
import requests
from collections import Counter

# -----------------------
# í˜ì´ì§€ ì„¤ì •
# -----------------------
st.set_page_config(
    page_title="ğŸ¬ ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?",
    page_icon="ğŸ¬",
    layout="wide",
)

# -----------------------
# TMDB ì¥ë¥´ ID ë§¤í•‘
# -----------------------
GENRE_MAP = {
    "ë¡œë§¨ìŠ¤/ë“œë¼ë§ˆ": [10749, 18],
    "ì•¡ì…˜/ì–´ë“œë²¤ì²˜": [28],
    "SF/íŒíƒ€ì§€": [878, 14],
    "ì½”ë¯¸ë””": [35],
}

# -----------------------
# ì‚¬ì´ë“œë°”
# -----------------------
with st.sidebar:
    st.header("ğŸ”‘ API ì„¤ì •")
    tmdb_api_key = st.text_input(
        "TMDB API Key",
        type="password",
        placeholder="TMDB API Key ì…ë ¥",
    )

# -----------------------
# ì œëª© & ì†Œê°œ
# -----------------------
st.title("ğŸ¬ ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?")
st.write(
    "ê°„ë‹¨í•œ ì§ˆë¬¸ì„ í†µí•´ **ë‹¹ì‹ ì˜ ì„±í–¥ì— ê¼­ ë§ëŠ” ì˜í™” ì¥ë¥´ì™€ ì¶”ì²œ ì˜í™”**ë¥¼ ì•Œë ¤ë“œë ¤ìš” ğŸ¿âœ¨  \n"
    "ëŒ€í•™ìƒì„ ìœ„í•œ ê°€ë²¼ìš´ ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤."
)

st.divider()

# -----------------------
# ì§ˆë¬¸ ë°ì´í„°
# -----------------------
questions = [
    (
        "â“ Q1. ì‹œí—˜ ëë‚œ ê¸ˆìš”ì¼ ë°¤, ë„ˆì˜ ì„ íƒì€?",
        {
            "â˜• ì¡°ìš©í•œ ì¹´í˜ì—ì„œ ì¹œêµ¬ë‘ ê¹Šì€ ì–˜ê¸°": "ë¡œë§¨ìŠ¤/ë“œë¼ë§ˆ",
            "ğŸš— ì¦‰í¥ ì—¬í–‰! ì•¼ê°„ ë“œë¼ì´ë¸Œë‚˜ ì•¡í‹°ë¹„í‹°": "ì•¡ì…˜/ì–´ë“œë²¤ì²˜",
            "ğŸ‘½ ì§‘ì—ì„œ ìƒìƒë ¥ í­ë°œ ì½˜í…ì¸  ëª°ì•„ë³´ê¸°": "SF/íŒíƒ€ì§€",
            "ğŸ˜‚ ì¹œêµ¬ë“¤ ëª¨ì—¬ ì›ƒê³  ë– ë“¤ê¸°": "ì½”ë¯¸ë””",
        },
    ),
    (
        "â“ Q2. ê³¼ì œ ë•Œë¬¸ì— ë°¤ìƒ˜í•  ë•Œ, ë„ˆë¥¼ ë²„í‹°ê²Œ í•˜ëŠ” ê±´?",
        {
            "ğŸ§ ê°ì • ëª°ì…ë˜ëŠ” í”Œë ˆì´ë¦¬ìŠ¤íŠ¸": "ë¡œë§¨ìŠ¤/ë“œë¼ë§ˆ",
            "ğŸ’ª ëë‚´ê³  ë†€ê² ë‹¤ëŠ” ìŠ¹ë¶€ìš•": "ì•¡ì…˜/ì–´ë“œë²¤ì²˜",
            "ğŸš€ ë¯¸ë˜ì˜ ë‚˜ë¥¼ ìƒìƒí•˜ëŠ” ìƒìƒë ¥": "SF/íŒíƒ€ì§€",
            "ğŸ¤£ ë°ˆê³¼ ì§¤, ì›ƒê¸´ ì˜ìƒ": "ì½”ë¯¸ë””",
        },
    ),
    (
        "â“ Q3. ì²˜ìŒ ê°„ MTì—ì„œ ë„ˆëŠ” ì–´ë–¤ ìºë¦­í„°?",
        {
            "ğŸŒ™ ì¡°ìš©íˆ ë¶„ìœ„ê¸° ì½ëŠ” íƒ€ì…": "ë¡œë§¨ìŠ¤/ë“œë¼ë§ˆ",
            "ğŸ”¥ ê²Œì„ê³¼ ë ˆí¬ë¦¬ì—ì´ì…˜ ì£¼ë„": "ì•¡ì…˜/ì–´ë“œë²¤ì²˜",
            "ğŸª ë…íŠ¹í•œ ì„¸ê³„ê´€ ë§Œë“œëŠ” ì‚¬ëŒ": "SF/íŒíƒ€ì§€",
            "ğŸ¤ ì›ƒìŒ í¬ì¸íŠ¸ ë‹´ë‹¹": "ì½”ë¯¸ë””",
        },
    ),
    (
        "â“ Q4. ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ê·¹ì— ë‹¬í–ˆì„ ë•Œ ì œì¼ í•˜ê³  ì‹¶ì€ ê±´?",
        {
            "ğŸ˜¢ í˜¼ì ê°ì • ì •ë¦¬í•˜ê¸°": "ë¡œë§¨ìŠ¤/ë“œë¼ë§ˆ",
            "ğŸƒâ€â™‚ï¸ ê²©í•˜ê²Œ ëª¸ ì“°ëŠ” í™œë™": "ì•¡ì…˜/ì–´ë“œë²¤ì²˜",
            "ğŸŒŒ í˜„ì‹¤ì„ ìŠëŠ” ë‹¤ë¥¸ ì„¸ê³„ë¡œ ë„í”¼": "SF/íŒíƒ€ì§€",
            "ğŸ» ì•„ë¬´ ìƒê° ì—†ì´ ì›ƒê¸°": "ì½”ë¯¸ë””",
        },
    ),
    (
        "â“ Q5. ì˜í™” ì£¼ì¸ê³µì´ ëœë‹¤ë©´, ë„ˆì˜ ì—­í• ì€?",
        {
            "ğŸ’ ê°ì •ì„ ì´ë„ëŠ” ì¤‘ì‹¬ ì¸ë¬¼": "ë¡œë§¨ìŠ¤/ë“œë¼ë§ˆ",
            "ğŸ¦¸ ìœ„ê¸°ë§ˆë‹¤ ëª¸ ë˜ì§€ëŠ” íˆì–´ë¡œ": "ì•¡ì…˜/ì–´ë“œë²¤ì²˜",
            "ğŸ”® ì„¸ê³„ì˜ ë¹„ë°€ì„ í‘¸ëŠ” ì¡´ì¬": "SF/íŒíƒ€ì§€",
            "ğŸ˜œ ë¶„ìœ„ê¸° ì‚´ë¦¬ëŠ” ì”¬ìŠ¤í‹¸ëŸ¬": "ì½”ë¯¸ë””",
        },
    ),
]

# -----------------------
# ì§ˆë¬¸ UI
# -----------------------
answers = []

for i, (question, options) in enumerate(questions):
    choice = st.radio(
        question,
        list(options.keys()),
        key=f"q{i}",
    )
    answers.append(options[choice])
    st.write("")

st.divider()

# -----------------------
# ê²°ê³¼ ë¶„ì„ & TMDB ì—°ë™
# -----------------------
if st.button("ğŸ¯ ê²°ê³¼ ë³´ê¸°", use_container_width=True):
    if not tmdb_api_key:
        st.error("âš ï¸ ì‚¬ì´ë“œë°”ì— TMDB API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        st.stop()

    # 1ï¸âƒ£ ì¥ë¥´ ë¶„ì„
    genre_count = Counter(answers)
    top_genre = genre_count.most_common(1)[0][0]

    st.subheader(f"ğŸ¥ ë‹¹ì‹ ì—ê²Œ ì–´ìš¸ë¦¬ëŠ” ì¥ë¥´: **{top_genre}**")

    # 2ï¸âƒ£ TMDB API í˜¸ì¶œ
    genre_ids = GENRE_MAP[top_genre]
    genre_query = ",".join(str(g) for g in genre_ids)

    url = (
        "https://api.themoviedb.org/3/discover/movie"
        f"?api_key={tmdb_api_key}"
        f"&with_genres={genre_query}"
        "&language=ko-KR"
        "&sort_by=popularity.desc"
    )

    response = requests.get(url)
    data = response.json()

    movies = data.get("results", [])[:5]

    st.write("### ğŸ¿ ì¶”ì²œ ì˜í™” TOP 5")

    # 3ï¸âƒ£ ì˜í™” ì¶œë ¥
    for movie in movies:
        col1, col2 = st.columns([1, 3])

        with col1:
            if movie.get("poster_path"):
                poster_url = "https://image.tmdb.org/t/p/w500" + movie["poster_path"]
                st.image(poster_url, use_container_width=True)
            else:
                st.write("ğŸï¸ í¬ìŠ¤í„° ì—†ìŒ")

        with col2:
            st.markdown(f"### {movie.get('title', 'ì œëª© ì—†ìŒ')}")
            st.write(f"â­ í‰ì : {movie.get('vote_average', 'N/A')}")
            st.write(movie.get("overview", "ì¤„ê±°ë¦¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."))

            st.info(
                f"ğŸ’¡ ì´ ì˜í™”ë¥¼ ì¶”ì²œí•˜ëŠ” ì´ìœ :  \n"
                f"ë‹¹ì‹ ì˜ ì„ íƒì—ì„œ **{top_genre}** ì„±í–¥ì´ ê°•í•˜ê²Œ ë‚˜íƒ€ë‚¬ì–´ìš”!"
            )

        st.divider()
